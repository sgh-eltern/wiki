jobs:
- name: Backup Wiki Database
  plan:
  - get: ci-tasks
    trigger: true
  - get: nightly
    trigger: true
  - task: Fetch Latest Database Backup from Strato
    file: ci-tasks/ci/fetch-backup/task.yml
    params:
      user: ((strato.user))
      ssh_key: ((strato.ssh-key))
      pointer_file: backup/mediawiki-db/latest
  - task: Store Backup in B2
    file: ci-tasks/ci/store-backup/task.yml
    params:
      endpoint: ((blobstore.endpoint))
      bucket: ((blobstore.bucket))
      access_key_id: ((blobstore.access-key-id))
      secret_access_key: ((blobstore.secret-access-key))

- name: Backup Wiki Files
  plan:
  - get: ci-tasks
    trigger: true
  - get: nightly
    trigger: true
  - task: Fetch Latest File Backup from Strato
    file: ci-tasks/ci/fetch-backup/task.yml
    params:
      user: ((strato.user))
      ssh_key: ((strato.ssh-key))
      pointer_file: backup/mediawiki-files/latest
  - task: Store Backup in B2
    file: ci-tasks/ci/store-backup/task.yml
    params:
      endpoint: ((blobstore.endpoint))
      bucket: ((blobstore.bucket))
      access_key_id: ((blobstore.access-key-id))
      secret_access_key: ((blobstore.secret-access-key))

resources:
  - name: ci-tasks
    type: git
    source:
      uri: https://github.com/sgh-eltern/wiki.git
      paths: [ ci/* ]
      branch: master

  - name: nightly
    type: time
    source: {interval: 24h}
